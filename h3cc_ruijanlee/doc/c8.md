H3Cc
=====

H3c connect  - 强力插入你的校园网 - @RuiJanLee

-----

8. windows共享网络
-----

因为确实共享上网是件挺麻烦，挺复杂的事情。  
首先很多人不知道电脑还可以共享WiFi。  
再次，即使按照网上的方法共享成功，  
但是并不能长久稳定的使用，总是出各种小问题，烦恼不已。  
下面我列出几种网上常见的传闻。  

然后我再讲解这些方法的原理，  
理解了原理我再教大家如何共享网络，  
这样我们对共享的网络比较了解，出了问题也知道如何解决。  
网络是生活中很重要的东西，这章可能略长，因为我尽量写的形象，  
相信各位看过之后一定对网络有很好的认识。  
最后我介绍一下目前硬件厂家对共享网络做的努力。

### 8.1 网上常见的方法

**8.1.1 - 使用CMD命令网卡虚拟成一个接入AP**  

[**例子链接**](http://itbbs.pconline.com.cn/mobile/11590200.html)  

```
netsh wlan set hostednetwork mode=allow    
承载网络模式设置为允许
netsh wlan set hostednetwork ssid=OPEN key=1234567890        
设置一个名字为OPEN的无线接入点，接入点密码为1234567890
netsh wlan start hostednetwork
启动承载网络
```

此方法设置繁复，  
客户端不能自动获取IP，  
手动设置IP异常繁复。  
而且那个CMD命令即使制作成脚本，  
依旧需要每次开机执行一次。  

**8.1.2 - 使用Connectify、wifi宝、wifi共享精灵**  


使用以上的软件，点击下一步，输入wifi的名称，密码。  
点击开始共享，然后软件开始运转，等上也许一会，也许很久。  

也许软件会提示共享失败，  
也许软件会提示共享成功，  
也许成功之后，连接上去老是掉线。  
也许连接之后电脑就变蓝屏死翘翘。  
也许之后电脑完全乱套，不能上网。

好吧，也许你用的挺好的。  
没发现什么问题。  

但是好几个人一起用你的wifi，  
你和别人都觉得好卡。

Connectify是收费软件，免费版本乱弹广告。  
后面两个是免费软件的国产软件，个人觉得有病毒。  

### 8.2 共享网络的原理与实战

计算机网络是一个自由开放的网络。  
首先想象两台电脑，用网线连上。  
分别设置IP地址192.168.1.1和192.168.1.2  
子网掩码都是255.255.255.0，不用网关  

这样子，我们就组建了一个局域网。  

真的吗？只有两台电脑一条网线？不用交网费？  
我们这是局域网，不是全世界连通的英特网。  
不信你可以试试玩玩局域网游戏，比如CS或者魔兽争霸。  
其中一台电脑共享的电影可以用另一台播放。  

好了，很自由，你可以自己组网。  

但是我想玩的是魔兽世界，想看网上的视频。  

OK，我们让其中一台电脑 A 连接互联网。  
（这台电脑有两个网卡，可以两条网线）  
（两张网卡的电脑不奇怪，笔记本都有两张网卡）  
（只不过一种一张是有线，一张是无线）

虽然另一台电脑 B 和连接了外网的电脑 A 连接，  
此时，不做任何设置，B 依旧不能上网。  

B 电脑只知道这世界有电脑 A ，  
但是从来不知道外面的世界。  
B 向大家说，有人知道baidu吗  
没人回答 B ，  
因为电脑 A 选择了沉默。 
于是 B 认为世界上没有baidu  

好了，让电脑 A 做做好人，  
A 有去往外界的通路，
如果 B 有访问外网的需求，就帮他转发吧。  

这样，A 共享了自己的连接。  
两台电脑都能连接外网。  
 

在windows中，这叫做 ICS（Internet 连接共享）。  
官方解释链接在此：  
[ ICS（Internet 连接共享）](http://windows.microsoft.com/zh-CN/windows7/Using-ICS-Internet-Connection-Sharing)


借用一下微软官方的图：  
![](https://raw.github.com/ruijanlee/h3cc/master/h3cc_ruijanlee/_img/c8-01.jpg)


好了，这个时候，我们就可以称 A 是 B 的网关。  
网关？好像网络参数里见过？干嘛用的？  
是网络的关卡？  

确实是的，想象一下，如果 B 的网络流量都是通过 A 来转发。  

当 B 和 baidu 说话的时候，是不是 A 可以检查（偷窥）其中的内容？  
是不是可以不让 B 访问某些网站(不转发某些数据)？  

事实上，A 要上网，也是有自己的网关的。  

不过这里我们先不管了，开始设置共享网络吧。  

思路基本就是，让 A 共享自己的网络，让 B 把 作为网关。  



首先打开电脑 A 的控制面板的网络连接。  

可以看到很多网卡。  

![](https://raw.github.com/ruijanlee/h3cc/master/h3cc_ruijanlee/_img/c8-02.jpg)

这里我是用无线网卡上网的，  
然后我又连接了一个PPPOE宽带拨号。  

宽带拨号在这里是一个虚拟的，逻辑上的网卡。  

我用一张有线网卡连接的另外一台电脑，（电脑 B ）  

这里我们共享宽带，只需点属性，  
在共享一栏就看到很多可以选择共享的目标网卡。  
这里选择连接电脑 B 的那个网卡。  
勾选如图的选项，确定之后马上就生效了。  

![](https://raw.github.com/ruijanlee/h3cc/master/h3cc_ruijanlee/_img/c8-03.jpg)


此时电脑 B 使用自动获取IP，连接上这个网卡，  
A 就自动给 B 分配IP地址，告诉 B 网关就是 A 。

到这里有线网络的网络共享就算是完结了，    
下面我们继续讲解无线网络的网络问题。  

### 8.3 无线网络的原理与实战

无线网络稍微比有线网路复杂一点，    
因为无线是空气中无形的魔法，  
看不见摸不着，我们怎么联网呢？  

首先我们想象有三个人，A B C  
他们一起在说话，相互交流。  

按照我们生活中的经验，  
三个人近距离面对面的交流，  
直接对着空气说就行了，大家都能听到。  

但是如果三个人距离得比较远，  

ABC依次站着，B站在A和C中间。  
A和B的距离远到刚好A说话B勉强能听见。  
B和C的距离远到刚好B说话C勉强能听见。  

这样子，再像刚才那样直接说，A和C就不能通话了是吧。  

对了，我们可以让在中间的B向C转达一下A的话。

好了，这就是有中心的通信模型。

在第一种通信模型中，三者平等，互相直接通信。  
在第二种通信模型中，有接入端，其他的都是客户端。  

**ad-hoc**

第一种叫做ad-hoc，是一种比较简单的网络，  
在wifi共享精灵软件中，winxp只能共享ad-hoc   
在win7中的创建方法如下图。  

![](https://raw.github.com/ruijanlee/h3cc/master/h3cc_ruijanlee/_img/c8-04.jpg)

创建完毕后，手机或者电脑连接上去相当于连接了网线。  
用有线网络共享的方法把外网共享到无线接口就可以了。  

注意的是多数版本的安卓手机不支持ad-hoc连接，  
不过可以找找补丁，iphone和电脑支持这种连接。  

这种连接比较鸡肋，不建议使用。  
而且win7共享的好像支持1个设备连接。  

下面我们来看第二种通信模型的共享方法。  

**接入点AP**

在win7的CMD命令行输入如下命令查看无线网卡信息  

```
netsh wlan show drivers
```

显示如下：  
![](https://raw.github.com/ruijanlee/h3cc/master/h3cc_ruijanlee/_img/c8-00.jpg)


首先，这里显示支持承载网络。  
在驱动文件里显示有两个文件，  
- RTL8192cu.sys
- vwifibus.sys  

第一个是网卡的驱动，  
第二个是作为接入点的驱动。  

bus在生活中是指公交车，  
在计算机中指总线，  
意思是有作为客户端连接别人的能力，  
还有做接入点让别人连接的能力。  

在winxp中为什么不支持Connectify呢？  
为什么wifi共享精灵只能共享ad-hoc呢？  

因为他们都没有驱动。  
市面上如此之多的网卡型号，  
这些软件没办法去找驱动。  

我以前共享wifi，经常蓝屏死机，  
其实都是因为网卡驱动问题，  
安装最新版本的驱动就解决了。  

在winxp中，有驱动，照样可以做接入点。  
所以，Connectify和wifi共享精灵都是坑货。  
在下面一节中，我用磊科的软件示范。  

如果你没有上述驱动，请到你的网卡的牌子的网站下载。  

有了驱动，我们使用以下命令，就可以开启一个接入点。  

```
netsh wlan set hostednetwork mode=allow    

netsh wlan set hostednetwork ssid=h3cc key=1234567890        

netsh wlan start hostednetwork

```

没错，这就是本文开头的那个命令。  

输入这个命令，你就开启了一个接入点，  
在网卡界面你会看到多了一个网卡。  
Microsoft Virtual WiFi Miniport Adapter   

使用有线网络的方法，把外网共享到此网卡，即可共享网络。  

使用一下命令关闭网卡。  
```
netsh wlan set hostednetwork mode=disallow
```

其实Connectify和wifi共享精灵只是自动帮你设置这些，  
所以你的系统没有驱动，他们是一点办法都没有。  

而且由于windows这个系统稳定性实在一般，  
所以这种共享的wifi说不定什么时候就出问题。  

对此我也没什么意见，好像有线共享还比较稳定。  
无线的话，据我同学的体会，是经常掉线的。  

所以这种东西，只是应急用用，平时还是用路由器的好。  

### 8.4 厂商提供的共享网络方案

**磊科网卡配套程序**   
我有两张磊科的无线网卡   
- nw336   
- nw337   
我用的网卡不多，   
感觉磊科的网卡便宜又好用。  

特别是配套的软件可以设置wifi共享，  
真是好，要知道Connectify是收费软件。  
而且Connectify不支持winxp的接入点哦。  

磊科的配套软件的原理和上面手动输入命令开启接入点是一样的。  

winxp没有内置接入点的驱动，所以不支持这些命令。  
所以第三方软件是实在没办法啊。  

磊科作为网卡官方，有驱动就好办。  

下图是磊科的截图。 

![](https://raw.github.com/ruijanlee/h3cc/master/h3cc_ruijanlee/_img/c8-05.jpg)


**360随身wifi**

写作此文的时候，360推出所谓的随身wifi。  

其实就是一张普通的无线网卡，只是360定制的。   
这样一来，自己决定了硬件，驱动就好办，  
直接集成在360里面，原理和上面的是一样的。

笔者对于360公司是有种抵触的态度的。  
所以这里不多介绍。  

360公司能取得如此多的用户，一方面也是用户体验好。  
解决了用户一些迫切的需求。  

但是其实就和我们的朝廷一个风气。  

天天弹窗说你开机快了，网速快了，系统优化了，没毒了。  
是不是很像新闻联播里面宣传的社会主义形势一片大好，  
人们欢欢喜喜生活美满，别的国家又在恐怖袭击，  
别国人们处于水生火热之中。   

你的幸福水平处于世界顶尖，感谢伟大领袖，  
你已经击败了世界上98%的人们。。。   

好了，我不说了。   
他们真实面目，大家都看在眼里。  


# [下一章](https://github.com/ruijanlee/h3cc/blob/master/h3cc_ruijanlee/doc/c9.md)